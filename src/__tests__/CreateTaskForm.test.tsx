import { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport { Provider } from 'react-redux';\nimport { configureStore } from '@reduxjs/toolkit';\nimport { rest } from 'msw';\nimport { setupServer } from 'msw/node';\nimport { CreateTaskForm } from '../components/CreateTaskForm';\nimport { appAPI } from '../service/api';\nimport type { TaskItem } from '../types/userTask';\n\n// Mock response\nconst mockTaskResponse: TaskItem = {\n  id: '123e4567-e89b-12d3-a456-426614174000',\n  title: 'Test Task',\n  descriptionMd: 'Test description',\n  statusId: 2,\n  statusName: 'Todo',\n  priorityId: 2,\n  priorityName: 'Medium',\n  dueAt: '2024-12-31T23:59:59Z',\n  estimateMinutes: 120,\n  spentMinutes: 0,\n  completedAt: null,\n  createdAt: '2024-01-01T09:00:00Z',\n  updatedAt: '2024-01-01T09:00:00Z',\n};\n\n// MSW server setup\nconst server = setupServer(\n  rest.post('*/user/task', (req, res, ctx) => {\n    return res(ctx.json(mockTaskResponse));\n  })\n);\n\nbeforeAll(() => server.listen());\nafterEach(() => server.resetHandlers());\nafterAll(() => server.close());\n\nconst createTestStore = () => {\n  return configureStore({\n    reducer: {\n      [appAPI.reducerPath]: appAPI.reducer,\n    },\n    middleware: (getDefaultMiddleware) =>\n      getDefaultMiddleware().concat(appAPI.middleware),\n  });\n};\n\nconst renderCreateTaskForm = (onSuccess = jest.fn(), onCancel = jest.fn()) => {\n  const store = createTestStore();\n  return render(\n    <Provider store={store}>\n      <CreateTaskForm onSuccess={onSuccess} onCancel={onCancel} />\n    </Provider>\n  );\n};\n\ndescribe('CreateTaskForm', () => {\n  it('renders all form fields', () => {\n    renderCreateTaskForm();\n    \n    expect(screen.getByLabelText(/title/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/description/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/priority/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/due date/i)).toBeInTheDocument();\n    expect(screen.getByLabelText(/estimated time/i)).toBeInTheDocument();\n  });\n\n  it('validates required fields', async () => {\n    renderCreateTaskForm();\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Title is required')).toBeInTheDocument();\n      expect(screen.getByText('Due date is required')).toBeInTheDocument();\n    });\n  });\n\n  it('validates title is not empty after trim', async () => {\n    renderCreateTaskForm();\n    \n    const titleInput = screen.getByLabelText(/title/i);\n    fireEvent.change(titleInput, { target: { value: '   ' } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Title is required')).toBeInTheDocument();\n    });\n  });\n\n  it('validates due date is not in the past', async () => {\n    renderCreateTaskForm();\n    \n    const dueDateInput = screen.getByLabelText(/due date/i);\n    const yesterday = new Date();\n    yesterday.setDate(yesterday.getDate() - 1);\n    const yesterdayString = yesterday.toISOString().slice(0, 16);\n    \n    fireEvent.change(dueDateInput, { target: { value: yesterdayString } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Due date must be today or in the future')).toBeInTheDocument();\n    });\n  });\n\n  it('validates estimate minutes is not negative', async () => {\n    renderCreateTaskForm();\n    \n    const estimateInput = screen.getByLabelText(/estimated time/i);\n    fireEvent.change(estimateInput, { target: { value: '-10' } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Estimate must be 0 or greater')).toBeInTheDocument();\n    });\n  });\n\n  it('validates description length', async () => {\n    renderCreateTaskForm();\n    \n    const descriptionInput = screen.getByLabelText(/description/i);\n    const longText = 'a'.repeat(10001);\n    fireEvent.change(descriptionInput, { target: { value: longText } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Description must be less than 10,000 characters')).toBeInTheDocument();\n    });\n  });\n\n  it('submits valid form successfully', async () => {\n    const onSuccess = jest.fn();\n    renderCreateTaskForm(onSuccess);\n    \n    // Fill form with valid data\n    fireEvent.change(screen.getByLabelText(/title/i), { target: { value: 'Test Task' } });\n    fireEvent.change(screen.getByLabelText(/description/i), { target: { value: 'Test description' } });\n    fireEvent.change(screen.getByLabelText(/priority/i), { target: { value: '2' } });\n    \n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    const tomorrowString = tomorrow.toISOString().slice(0, 16);\n    fireEvent.change(screen.getByLabelText(/due date/i), { target: { value: tomorrowString } });\n    \n    fireEvent.change(screen.getByLabelText(/estimated time/i), { target: { value: '120' } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(onSuccess).toHaveBeenCalled();\n    });\n  });\n\n  it('handles server errors gracefully', async () => {\n    server.use(\n      rest.post('*/user/task', (req, res, ctx) => {\n        return res(ctx.status(400), ctx.json({ message: 'Server validation error' }));\n      })\n    );\n    \n    renderCreateTaskForm();\n    \n    // Fill form with valid data\n    fireEvent.change(screen.getByLabelText(/title/i), { target: { value: 'Test Task' } });\n    \n    const tomorrow = new Date();\n    tomorrow.setDate(tomorrow.getDate() + 1);\n    const tomorrowString = tomorrow.toISOString().slice(0, 16);\n    fireEvent.change(screen.getByLabelText(/due date/i), { target: { value: tomorrowString } });\n    \n    const submitButton = screen.getByText('Create Task');\n    fireEvent.click(submitButton);\n    \n    await waitFor(() => {\n      expect(screen.getByText('Server validation error')).toBeInTheDocument();\n    });\n  });\n\n  it('calls onCancel when cancel button is clicked', () => {\n    const onCancel = jest.fn();\n    renderCreateTaskForm(jest.fn(), onCancel);\n    \n    const cancelButton = screen.getByText('Cancel');\n    fireEvent.click(cancelButton);\n    \n    expect(onCancel).toHaveBeenCalled();\n  });\n});